if status is-interactive
    # Load environment variables from ~/.env (using bass for bash compatibility)
    if test -f ~/.env
        bass source ~/.env
    end

    # Set default editor
    set -gx EDITOR zed

    # PATH configuration
{{- if stat "/opt/homebrew/bin/brew" }}
    set -l brew_prefix /opt/homebrew
{{- else }}
    set -l brew_prefix /usr/local
{{- end }}
    fish_add_path $brew_prefix/bin
    fish_add_path $brew_prefix/opt/llvm/bin
    fish_add_path $brew_prefix/opt/openjdk/bin
    fish_add_path $brew_prefix/opt/erlang@22/bin
    fish_add_path $brew_prefix/opt/coreutils/libexec/gnubin
    fish_add_path $brew_prefix/opt/ruby/bin
    fish_add_path $brew_prefix/sbin
    fish_add_path $HOME/.cargo/bin
    fish_add_path $brew_prefix/opt/openssl@1.1/bin
    fish_add_path $HOME/go/bin
    fish_add_path $HOME/.rd/bin
    fish_add_path $HOME/.pixi/bin
    fish_add_path $HOME/.codeium/windsurf/bin

    # Tide prompt customization (overrides Rainbow theme defaults)
    set -g tide_left_prompt_items pwd git newline
    set -U tide_git_icon \uE0A0
    # Remove node version from the right prompt
    set -U tide_right_prompt_items (string match -v node $tide_right_prompt_items)

    # History substring search keybindings (matching zsh behavior)
    bind \e\[A history-prefix-search-backward
    bind \e\[B history-prefix-search-forward
    bind \cp history-prefix-search-backward
    bind \cn history-prefix-search-forward

    # Fix conflict: let fifc handle Tab instead of pisces
    # Pisces overrides Tab for completing vars before closing quotes,
    # but fifc provides better fzf-powered completion
    bind \t _fifc
    bind --mode insert \t _fifc

    # FZF configuration
    set -gx FZF_DEFAULT_COMMAND "fd --type file --color=always"
    # Arrow keys navigate (default), Enter accepts selection
    set -gx FZF_DEFAULT_OPTS "--ansi --color fg:-1,bg:-1,hl:230,fg+:3,bg+:233,hl+:229 --color info:150,prompt:110,spinner:150,pointer:167,marker:174"

    # fzf.fish configuration
    set -g fzf_preview_dir_cmd eza --icons -1 --color=always
    set -g fzf_preview_file_cmd bat --color=always
    set -g fzf_fd_opts --hidden --exclude=.git

    # Aliases
    alias ls='eza'
    alias cat='bat --theme=(if test (defaults read -globalDomain AppleInterfaceStyle 2>/dev/null) = Dark; echo default; else; echo GitHub; end)'
    # Branch function: creates new branch tracking upstream but pushing to origin
    function branch
        set branch_name $argv[1]

        # Determine which remote to use (prefer upstream, fallback to origin)
        if git remote | grep -q '^upstream$'
            set remote upstream
        else
            set remote origin
        end

        # Get the default branch from the remote
        set default_branch (gh repo view $remote --json defaultBranchRef --jq .defaultBranchRef.name 2>/dev/null)

        # Fallback to git's method if gh fails
        if test -z "$default_branch"
            set default_branch (git symbolic-ref refs/remotes/$remote/HEAD 2>/dev/null | sed "s@^refs/remotes/$remote/@@")
        end

        # Final fallback to common branch names
        if test -z "$default_branch"
            for branch in main master
                if git rev-parse --verify $remote/$branch >/dev/null 2>&1
                    set default_branch $branch
                    break
                end
            end
        end

        # Execute branch creation
        git checkout $default_branch && \
        git pull $remote $default_branch && \
        git checkout -b $branch_name && \
        git branch --set-upstream-to=$remote/$default_branch $branch_name && \
        git config branch.$branch_name.pushRemote origin
    end
    alias ghpr='GH_FORCE_TTY=100% gh pr list | fzf --ansi --preview "GH_FORCE_TTY=100% gh pr view {1}" --preview-window down --header-lines 3 | awk \'{print $1}\' | xargs gh pr checkout'
    alias masked='maskedemail-cli --token $fastmail_token'
    alias python='python3'

    # remove greeting
    set fish_greeting

    # Shared history across sessions (like zsh SHARE_HISTORY)
    # Merge history from other sessions before displaying prompt
    function __sync_history --on-event fish_prompt
        history merge
    end

    # Functions
    function ezad
        if test (count $argv) -eq 0
            eza --icons --all --color=always --group-directories-first
        else
            eza --icons --all --color=always --group-directories-first $argv
        end
    end

    # Auto ls after cd (matching zsh chpwd_functions)
    function __auto_ls_after_cd --on-variable PWD
        if status is-interactive
            eza --icons --all --color=always --group-directories-first
        end
    end

    # Initialize direnv for per-directory environment variables
    command -q direnv && direnv hook fish | source

    # Initialize 1Password CLI
    if command -v op >/dev/null
        op completion fish | source
        if test -f ~/.config/op/plugins.sh
            # Note: plugins.sh is bash, may need fish conversion
        end
    end

    # Initialize pixi
    if command -v pixi >/dev/null
        pixi completion --shell fish | source
    end

    # Initialize zoxide (equivalent to autojump/z)
    if command -v zoxide >/dev/null
        zoxide init fish --cmd j | source
    end

    # Initialize mise (formerly rtx) - handles Node, Ruby, Python, Java versions
    if command -v mise >/dev/null
        mise activate fish | source
    end

    # Initialize conda if available
{{- if stat "/opt/homebrew/bin/brew" }}
    if test -f /opt/homebrew/Caskroom/miniconda/base/etc/fish/conf.d/conda.fish
        source /opt/homebrew/Caskroom/miniconda/base/etc/fish/conf.d/conda.fish
    end
{{- else }}
    if test -f /usr/local/Caskroom/miniconda/base/etc/fish/conf.d/conda.fish
        source /usr/local/Caskroom/miniconda/base/etc/fish/conf.d/conda.fish
    end
{{- end }}

    # Initialize mamba if available
{{- if stat "/opt/homebrew/bin/brew" }}
    if test -f /opt/homebrew/Caskroom/miniconda/base/etc/fish/conf.d/mamba.fish
        source /opt/homebrew/Caskroom/miniconda/base/etc/fish/conf.d/mamba.fish
    end
{{- else }}
    if test -f /usr/local/Caskroom/miniconda/base/etc/fish/conf.d/mamba.fish
        source /usr/local/Caskroom/miniconda/base/etc/fish/conf.d/mamba.fish
    end
{{- end }}

    # Initialize SDKMAN using bass
    if test -f $HOME/.sdkman/bin/sdkman-init.sh
        set -gx SDKMAN_DIR $HOME/.sdkman
        # SDKMAN functions available via: bass source "$SDKMAN_DIR/bin/sdkman-init.sh"
        # Or create wrapper functions in conf.d if needed
    end

    # iTerm2 shell integration
    if test -f ~/.iterm2_shell_integration.fish
        source ~/.iterm2_shell_integration.fish
    end

    # fzf key bindings (if not using fzf.fish plugin)
    if test -f ~/.config/fish/functions/fzf_key_bindings.fish
        fzf_key_bindings
    end
end
